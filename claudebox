#!/usr/bin/env bash
set -euo pipefail

REPO="${1:-$PWD}"
CONTAINER_NAME="claudebox-${RANDOM}"
MODE="${AI_SANDBOX_MODE:-auto}"

MCP_CONFIG='{"mcpServers":{"shopify-dev-mcp":{"command":"/usr/local/bin/shopify-dev-mcp","args":[]}}}'

# Collect bind mounts only for host paths that already exist. This avoids
# statfs errors while still preserving settings when available.
HOST_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
HOST_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}"
HOST_DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}"
vols=()
if [[ -d "$HOME/.claude" ]]; then vols+=(-v "$HOME/.claude:/tmp/.claude:rw"); fi
if [[ -d "$HOST_CONFIG_DIR/claude" ]]; then vols+=(-v "$HOST_CONFIG_DIR/claude:/tmp/.config/claude:rw"); fi
if [[ -d "$HOST_CACHE_DIR/claude" ]]; then vols+=(-v "$HOST_CACHE_DIR/claude:/tmp/.cache/claude:rw"); fi
if [[ -d "$HOST_CONFIG_DIR/anthropic/claude" ]]; then vols+=(-v "$HOST_CONFIG_DIR/anthropic/claude:/tmp/.config/anthropic/claude:rw"); fi
if [[ -d "$HOST_CACHE_DIR/anthropic/claude" ]]; then vols+=(-v "$HOST_CACHE_DIR/anthropic/claude:/tmp/.cache/anthropic/claude:rw"); fi
if [[ -d "$HOST_DATA_DIR/claude" ]]; then vols+=(-v "$HOST_DATA_DIR/claude:/tmp/.local/share/claude:rw"); fi
if [[ -d "$HOST_DATA_DIR/anthropic/claude" ]]; then vols+=(-v "$HOST_DATA_DIR/anthropic/claude:/tmp/.local/share/anthropic/claude:rw"); fi
if [[ -d "$HOME/.config/gh" ]]; then vols+=(-v "$HOME/.config/gh:/tmp/.config/gh:ro"); fi

run_podman() {
  podman run --rm -it \
    --name "$CONTAINER_NAME" \
    --userns=keep-id \
    --cap-drop=ALL \
    --cap-add=NET_ADMIN \
    --device=/dev/net/tun \
    --security-opt=no-new-privileges \
    --network=slirp4netns \
    -v "$REPO:/workspace:rw" \
    -e HOME=/tmp \
    -e XDG_CONFIG_HOME=/tmp/.config \
    -e XDG_CACHE_HOME=/tmp/.cache \
    -e XDG_DATA_HOME=/tmp/.local/share \
    "${vols[@]}" \
    -w /workspace \
    ai-sandbox:latest \
    -c "claude --dangerously-skip-permissions --mcp-config '$MCP_CONFIG'"
}

copy_if_dir() {
  local src=$1 dst=$2
  if [[ -d "$src" ]]; then
    mkdir -p "$(dirname "$dst")"
    cp -a "$src" "$dst"
  fi
}

run_host() {
  local sandbox_home
  sandbox_home=$(mktemp -d "${TMPDIR:-/tmp}/claudebox-XXXXXX")
  cleanup() { rm -rf "$sandbox_home"; }
  trap cleanup EXIT INT TERM

  copy_if_dir "$HOME/.config/gh" "$sandbox_home/.config/gh"
  copy_if_dir "$HOME/.claude" "$sandbox_home/.claude"
  copy_if_dir "$HOST_CONFIG_DIR/claude" "$sandbox_home/.config/claude"
  copy_if_dir "$HOST_CACHE_DIR/claude" "$sandbox_home/.cache/claude"
  copy_if_dir "$HOST_CONFIG_DIR/anthropic/claude" "$sandbox_home/.config/anthropic/claude"
  copy_if_dir "$HOST_CACHE_DIR/anthropic/claude" "$sandbox_home/.cache/anthropic/claude"
  copy_if_dir "$HOST_DATA_DIR/claude" "$sandbox_home/.local/share/claude"
  copy_if_dir "$HOST_DATA_DIR/anthropic/claude" "$sandbox_home/.local/share/anthropic/claude"

  export HOME="$sandbox_home"
  export XDG_CONFIG_HOME="$sandbox_home/.config"
  export XDG_CACHE_HOME="$sandbox_home/.cache"
  export XDG_DATA_HOME="$sandbox_home/.local/share"

  local cmd
  if command -v claude >/dev/null 2>&1; then
    cmd=(claude)
  else
    cmd=(npx --yes @anthropic-ai/claude-code@latest)
  fi

  cd "$REPO"
  "${cmd[@]}" --dangerously-skip-permissions --mcp-config "$MCP_CONFIG"
}

if [[ "$MODE" != "host" && -x "$(command -v podman || true)" ]]; then
  if run_podman; then
    exit 0
  fi
  echo "podman failed; falling back to host mode (set AI_SANDBOX_MODE=host to skip podman)" >&2
elif [[ "$MODE" != "host" ]]; then
  echo "podman not available; using host mode" >&2
fi

run_host
